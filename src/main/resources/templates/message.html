<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>博客分类</title>

    <link href="webjars/bootstrap/3.3.7/css/bootstrap.min.css" th:href="@{webjars/bootstrap/3.3.7/css/bootstrap.min.css}" rel="stylesheet">
    <link href="assets/css/potal/message.css" rel="stylesheet">
    <!--分页插件-->
    <link href="/pagination/pagination.css" rel="stylesheet">
</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-lg-12">
            <span class="top">欢迎光临！<a href="/toLogin">登录 </a></span>
        </div>
    </div>
</div>
<nav class="navbar navbar-default navbar-color" role="navigation" style="background: #0099CC">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse"
                    data-target="#example-navbar-collapse">
                <span class="sr-only">切换导航</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">个人博客</a>
        </div>
        <div class="collapse navbar-collapse" id="example-navbar-collapse">
            <ul class="nav navbar-nav" id="nav">
                <li><a href="/">首页</a></li>

            </ul>
        </div>
    </div>
</nav>
<div class="container">
    <div class="row">
        <div class="col-lg-9">
            <header>
                <h1>留言</h1>
            </header>
            <li id="append">
                <div id="commit">
                <div id="commit-header">
                    <span th:if="${session.member != null}">
                        <img  th:src="@{/image/pic/{image}(image=${session.member.image})}" >
                        <span><a href="/main" th:text="${session.member.username}"> </a>快来发表你的留言吧</span>
                        <input type="hidden" th:value="${session.member.id}" id="memberid">
                    </span>
                    <span th:unless="${session.member != null}">
                        <img  src="/image/3.png" width="30px" height="30px">
                        <span><a href="/toLogin">登录</a>给我留言</span>
                    </span>
                </div>
                <div id="commit-content">
                    <small>写点什么...</small>
                    <textarea id="messagecontent" maxlength="500" onchange="this.value=this.value.substring(0, 500)" onkeydown="this.value=this.value.substring(0, 500)" onkeyup="this.value=this.value.substring(0, 500)" ></textarea>
                    <button type="button" class="btn btn-primary" style="float:right;" onclick="submitMessage()" >提交留言</button>
                </div>
            </div>
            </li>
            <div id="commit-comtent">
                <div id="commit-content-top">
                    <span class="glyphicon glyphicon-comment " id="messagenum"> </span>
                </div>
                <div id="commit-content-content">
                    <ul>

                    </ul>
                    <div id="Pagination" class="pagination"><!-- 这里显示分页 --></div>
                </div>
            </div>
            <input type="hidden" id="pageno" name="1">
        </div>
        <div class="col-lg-3">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <span class="glyphicon glyphicon-align-justify"></span> 热门排行</div>
                <div class="panel-body">
                    <ul id="popular">

                    </ul>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">
                    <span class="glyphicon glyphicon-align-justify"></span> 标签库</div>
                <div class="panel-body label-button" id="label">

                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">
                    <span class="glyphicon glyphicon-align-justify"></span> 猜你喜欢</div>
                <div class="panel-body">
                    <ul id="like">

                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="footer">

</div>
<script src="/plugins/jQuery/jQuery-2.1.4.min.js"></script>
<script src="/bootstrap/js/bootstrap.js"></script>
<!--分页插件-->
<script src="/pagination/jquery.pagination.js"></script>
<script src="/layer/layer.js"></script>
<script>
    window.onload=function(){
        loadNav();
        loadMessage(0)
        loadPopular();  //热门排行
        loadLabel();
        loadLike()

    }

    //加载导航条
    function loadNav(){
        $.ajax({
            type:"post",
            url: "/loadNav",
            success : function(result){
                if(result.success){
                    var data = result.typeList;
                    var content = "";
                    $.each(data,function(i,n){
                        if(n.typeList.length != 0){

                            content += " <li id='"+n.id+"' class='dropdown'>";
                            content += "<a href='"+n.url+"?id="+n.id+"' class='dropdown-toggle' data-toggle='dropdown'>";
                            content +=n.name+ "<b class='caret'></b>";
                            content += " </a>";
                            content += "<ul  class='dropdown-menu'>";
                            $.each(n.typeList,function(i,b){
                                content += "<li><a href='"+b.url+"?id="+b.id+"'>"+b.name+"</a></li>";
                            });
                            content += "</ul>";
                            content += "</li>";
                        }else{

                            content += "<li id='"+n.id+"'><a href='"+n.url+"?id="+n.id+"'>"+n.name+"</a></li>";
                        }
                    });
                    content += "<li class='active'><a href='/message'>留言</a></li>";
                    $("#nav").append(content);
                }else{
                    alert("系统异常！");
                }
            }

        })

    }
    //热门排行
    function loadPopular(){
        $.ajax({
            type : "post",
            url : "/loadPopular",
            success : function(result){
                if(result.success){
                    var data = result.articleList;
                    var content = "";
                    $.each(data,function(i,n){
                        content += " <li>";
                        if(i == 0){
                            content += " <span class='label-1'>"+(i+1)+"</span>";
                        }else if(i == 1){
                            content += " <span class='label-2'>"+(i+1)+"</span>";
                        }else if(i == 2){
                            content += " <span class='label-3'>"+(i+1)+"</span>";
                        }else{
                            content += " <span class='label-4'>"+(i+1)+"</span>";
                        }
                        content += "  <a href='/article?id="+n.id+"'>"+n.title+"</a>";
                        content += " </li>";
                    });
                    $("#popular").html(content);
                }
            }
        })
    }
    //标签库
    function loadLabel(){
        $.ajax({
            type: "post",
            url: "/loadLabel",
            success: function (result) {
                if (result.success) {
                    var data = result.ldata;
                    var content = "";
                    $.each(data, function (i, n) {
                        content += " <button onclick='toTag("+n.id+")'>" + n.name + "</button>";
                    });
                    $("#label").html(content);
                }
            }
        })
    }
    function toTag(id){
        window.location.href="/tag?id="+id;
    }
    //猜你喜欢
    function loadLike(){
        $.ajax({
            type : "post",
            url : "/loadLike",
            success :function(result){
                if(result.success){
                    var data = result.articleResults;
                    var content = "";
                    $.each(data,function(i,n){
                        content += " <li class='like'>";
                        content += " <span class='like-1'>";
                        content += " <img src='/image/thumbnail/"+n.picture.iconpath+"'>";
                        content += " </span>";
                        content += " <span class='like-2'>";
                        content += " <a href='/article?id="+n.id+"'>"+n.title+"</a>";
                        content += " </span>";
                        content += " <span class='like-3'>"+n.creationtime+"</span>";
                        content += " <span class='like-4'>"+n.likenum+"喜欢</span>";
                        content += " </li>";
                    });
                    $("#like").html(content);
                }
            }
        })
    }
    //写点什么隐藏与显示
    $("textarea").click(function(){
        $("small").hide()
    })
    $("textarea").blur(function(){
        if($("textarea").val() == ""){
            $("small").show()
        }
    })
    $(".reply").click(function(){
        $("#22").after($("#append"))
    })
    //加载留言
    function loadMessage(pageno){
        $.ajax({
            type:"post",
            data : {
                "pagesize" : 10,
                "pageno" : pageno+1,
            },
            url : "/loadMessage",
            success : function(result){
                if(result.success){
                    var page = result.page;
                    var data = page.messageResultList;
                    $("#messagenum").text("("+data.length+")个小伙伴在吐槽");
                    var content = "";
                    $.each(data,function(i,n){
                        content += "<li>";
                        content += " <div class='userimage'>";
                        content += "<img src='/image/pic/"+n.image+"'>";
                        content += "</div>";
                        content += "<div class='commit'>";
                        content += "<p>"+n.content;
                        content += "</p>";
                        content += "<span>"+n.username+" </span>";
                        content += "<span>"+n.createtime+"</span>";
                        content += "</div>";
                        content += "</li>";
                        if(n.reply != null){
                            content += "<li style='margin-left: 80px'>";
                            content += " <div class='userimage'>";
                            content += "<img src='/image/3.png'>";
                            content += "</div>";
                            content += "<div class='commit'>";
                            content += "<p>"+n.reply;
                            content += "</p>";
                            content += "<span>管理员回复"+n.username+" </span>";
                            content += "</div>";
                            content += "</li>";
                        }
                    });
                    // 创建分页
                    var num_entries = page.totalsize ;
                    $("#Pagination").pagination(num_entries, {
                        num_edge_entries: 2, //边缘页数
                        num_display_entries: 4, //主体页数
                        callback: loadMessage,
                        items_per_page:page.pagesize, //每页显示1项
                        current_page:(page.pageno-1), //当前页,索引从0开始
                        prev_text:"上一页",
                        next_text:"下一页"
                    });
                    //记录当前页
                    $("#pageno").val(page.pageno);
                    $("#commit-content-content ul").html(content);
                }
            }
        })
    }
    //提交
    function submitMessage(){
        var memberid = $("#memberid").val();
        if(memberid == null){
            layer.msg("请先登录再评论！", {time:3000, icon:5, shift:6});
        }else{
            alert($("#messagecontent").val());
            if($("#messagecontent").val() == ""){
                layer.msg("留言内容不能为空！", {time:3000, icon:5, shift:6});
            }else{
                $.ajax({
                    type:"post",
                    data : {
                        "memberid" : memberid,
                        "content" : $("#messagecontent").val()
                 },
                    url : "/submitMessage",
                    success : function(result){
                        if(result.success){
                            $("#messagecontent").val("");
                            $("small").show()
                            loadMessage(0)

                        }else{
                            layer.msg("留言失败！", {time:3000, icon:5, shift:6});
                        }
                    }
               })
            }

        }
    }

</script>
<script>
    $(document).ready(function(){
        $(document).off('click.bs.dropdown.data-api');
    });
</script>
</body>
</html>